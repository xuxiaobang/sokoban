<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style type='text/css'>
    * {
      margin: 0;
      padding: 0;
    }

    #btn {
      width: 50%;
      margin-top: 50px;
      position: relative;
      left: 50%;
    }

    #wrap {
      margin: 0px auto;
      background: url(img/block.gif);
      position: relative;
    }

    #wrap div {
      width: 35px;
      height: 35px;
      position: absolute;
      /*float:left;*/
      transition: .1s;
    }

    #wrap div img {
      position: absolute;
      bottom: 0;
    }

    #wrap div.ball img {
      left: 50%;
      bottom: 50%;
      margin-left: -15px;
      margin-bottom: -15px;
    }

    /*
			#wrap div.wall{
				z-index:3;
			}
			#wrap div.box{
				z-index:1;
			}
			#wrap div.person{
				z-index:2;
			}
			*/
    #wrap div.person img {
      left: 50%;
      margin-left: -25px;
    }
  </style>


</head>

<body>

  <div id="btn">

    <input type="button" id="auto" value="哥！救我！" />
    <input type="button" id="prev" value='上一步' />

    <input type="button" id="nextLevel" value="下一关" />
    <input type="button" id="prevLevel" value="上一关" />
  </div>
  <div id="wrap"></div>

  <script>
    // 获取wrap元素
    var oWrap = document.getElementById('wrap');

    // 地图的宽高大小
    var size = { x: 16, y: 16 }

    // 第几关
    var level = 0;

    // 步骤次数统计
    var stepNum = 0;

    // 步骤存储器
    var step = {
      // 人物的步骤数据存储
      person: [],

      // 箱子的参数存储
      box: []
    }


    // 关卡数据
    var mapData = [
      // 第一关数据
      [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 1, 2, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 0,
        0, 0, 0, 0, 1, 1, 1, 3, 0, 3, 2, 1, 0, 0, 0, 0,
        0, 0, 0, 0, 1, 2, 0, 3, 4, 1, 1, 1, 0, 0, 0, 0,
        0, 0, 0, 0, 1, 1, 1, 1, 3, 1, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 1, 2, 1, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
      ],
      // 第二个数据
      [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 1, 4, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 1, 0, 3, 3, 1, 0, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 0, 1, 0, 3, 0, 1, 0, 1, 2, 1, 0, 0, 0,
        0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 2, 1, 0, 0, 0,
        0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 2, 1, 0, 0, 0,
        0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0,
        0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
      ],
      // 第三关
      [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, 1, 0, 0, 0,
        0, 0, 0, 0, 1, 1, 0, 0, 3, 2, 2, 2, 1, 0, 0, 0,
        0, 0, 0, 0, 1, 0, 0, 3, 0, 1, 5, 2, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 0, 1, 1, 3, 1, 0, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 0, 0, 0, 3, 0, 0, 3, 0, 1, 0, 0, 0,
        0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 4, 0, 1, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
      ],
      //  第四关
      [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0,
        0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 4, 1, 1, 0, 0, 0,
        0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 3, 0, 1, 1, 0, 0,
        0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 0, 3, 0, 1, 0, 0,
        0, 0, 0, 0, 1, 2, 2, 2, 2, 0, 3, 0, 0, 1, 0, 0,
        0, 0, 0, 0, 1, 0, 2, 2, 2, 1, 0, 0, 0, 1, 0, 0,
        1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0,
        1, 0, 3, 0, 3, 0, 0, 0, 3, 0, 0, 1, 0, 0, 1, 0,
        1, 0, 0, 0, 0, 3, 3, 0, 0, 0, 3, 0, 3, 0, 1, 0,
        1, 1, 1, 0, 3, 0, 3, 0, 3, 0, 0, 1, 1, 1, 1, 0,
        0, 0, 1, 1, 0, 0, 0, 3, 0, 3, 0, 1, 0, 0, 0, 0,
        0, 0, 0, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
      ],
      []
    ]

    //自动过关数据
    var auto = [
      [40, 38, 37, 37, 39, 38, 38, 40, 39, 39],
      []
    ];


    //执行初始化
    init();

    // 初始化
    function init() {
      oWrap.style.cssText = 'width:' + size.x * 35 + 'px;height:' + size.y * 35 + 'px;';

      // 上一步
      document.getElementById('prev').onclick = prev;

      // 上一关 
      document.getElementById('prevLevel').onclick = function () {
        if (level > 0) {
          level--;
          createMap(level);
        }
      }

      // 下一关
      document.getElementById('nextLevel').onclick = function () {
        if (level < mapData.length - 2) {
          level++;
        } else {
          alert('你已经全通关了');
          level = 0;
        }
        createMap(level);
      }

      // 自动播放
      document.getElementById('auto').onclick = function () {
        // 创建地图
        createMap(level);

        // 获取人物盒子
        var oParent = getBox('person')[0]

        // 获取人物图片
        var oP = oParent.children[0];

        // 定义计数
        var kNum = 0;

        // 开启定时器模拟按键
        var timer = setInterval(function () {
          var keyCode = auto[level][kNum];
          controlFn(oP, oParent, keyCode);

          kNum++;

          // 判断清除定时器
          if (kNum == auto[level].length) {
            clearInterval(timer)
          }
        }, 500)


      }

      createMap(level);
    }


    // 创建地图
    function createMap(lv) {
      //地图大小
      var oPerson, oDiv, oImg;
      oWrap.innerHTML = '';
      // 初始化步骤信息
      step.person = [];
      step.box = [];
      stepNum = 0;

      //创建 16*16个小格子
      for (var i = 0; i < size.x * size.y; i++) {
        switch (mapData[lv][i]) {
          case 1:
            appDiv(i);
            oImg.src = 'img/wall.png';
            oDiv.className = 'wall';
            break;
          case 2:
            appDiv(i);
            oImg.src = 'img/ball.png';
            oDiv.className = 'ball';
            oDiv.style.zIndex = 0;
            break;
          case 3:
            appDiv(i);
            oImg.src = 'img/box.png';
            oDiv.className = 'box';
            break;
          case 4:
            appDiv(i);
            oImg.src = 'img/down.png';
            oDiv.className = 'person';
            oPerson = oImg;
            break;
        }
      }

      // 调用控制人物函数
      controlPerson(oPerson)

      // 创建div 和img标签
      function appDiv(i) {
        var x = i % size.x;
        var y = parseInt(i / size.x)
        oDiv = document.createElement('div');
        oDiv.x = x;
        oDiv.y = y;
        oDiv.style.cssText = 'left:' + x * 35 + 'px;top:' + y * 35 + 'px;z-index:' + (y * size.x) + ';';
        oImg = new Image();
        oDiv.appendChild(oImg);
        oWrap.appendChild(oDiv);
      }

    }

    // 控制人物
    function controlPerson(oP) {

      var oParent = oP.parentNode;
      document.onkeydown = function (ev) {
        ev = ev || window.event;
        var keyCode = ev.keyCode;
        controlFn(oP, oParent, keyCode)

      }
    }

    // 控制函数
    function controlFn(oP, oParent, keyCode) {
      // 记录移动信息
      // 在stepNum的每一步都在step中person和创建一个空对象
      // 并且把图片的src信息保存在这个对象的src中
      step.person[stepNum] = {}
      step.person[stepNum].src = oP.src

      switch (keyCode) {
        // 左
        case 37:
          oP.src = 'img/left.png';
          movePerson({ x: -1 }, oParent)
          break;
        // 上
        case 38:
          oP.src = 'img/up.png';
          movePerson({ y: -1 }, oParent)
          break;
        // 右
        case 39:
          oP.src = 'img/right.png';
          movePerson({ x: 1 }, oParent)
          break;
        // 下
        case 40:
          oP.src = 'img/down.png';
          movePerson({ y: 1 }, oParent)
          break;
      }

    }

    // 人物移动
    function movePerson(mJson, oParent) {
      var x = mJson.x || 0;
      var y = mJson.y || 0;

      // 获取box的个数
      var oBox = getBox('box', oWrap)

      if (mapData[level][(oParent.x + x) + (oParent.y + y) * size.x] != 1) {
        // 移动前记录前一个的位置信息
        // 在step.person中记录人物移动前的位置信息
        step.person[stepNum].x = oParent.x;
        step.person[stepNum].y = oParent.y;

        // oParent移动
        oParent.x += x;
        oParent.y += y;
        oParent.style.left = oParent.x * 35 + 'px';
        oParent.style.top = oParent.y * 35 + 'px';
        oParent.style.zIndex = oParent.x + oParent.y * size.x;

        // 步骤加一
        stepNum++;

        // 遍历所有的箱子
        for (var i = 0; i < oBox.length; i++) {
          // 判断箱子的位置是不是在人物的上一步
          if (oBox[i].x == oParent.x && oBox[i].y == oParent.y) {
            // 判断箱子上一步是不是墙壁
            if (mapData[level][(oBox[i].x + x) + (oParent.y + y) * size.x] != 1) {

              //判断碰撞检测
              if (collision(oBox[i], x, y)) {
                // 移动箱子之前记录之前的位置
                // 箱子也是  每次移动都在step中创建一个对象 保存箱子移动前 及箱子的下标
                step.box[stepNum - 1] = {};
                step.box[stepNum - 1].index = i;
                step.box[stepNum - 1].x = oBox[i].x;
                step.box[stepNum - 1].y = oBox[i].y

                // 移动箱子
                oBox[i].x += x;
                oBox[i].y += y;
                oBox[i].style.left = oBox[i].x * 35 + 'px';
                oBox[i].style.top = oBox[i].y * 35 + 'px';
                oBox[i].style.zIndex = oBox[i].y * size.x;

                // 执行过关函数判断有没有过关
                pass();
              } else {

                oParent.x -= x;
                oParent.y -= y;
                oParent.style.left = oParent.x * 35 + 'px';
                oParent.style.top = oParent.y * 35 + 'px';
                oParent.style.zIndex = oParent.x + oParent.y * size.x;

                // 减少步骤移动
                stepNum--;
                step.person.pop();

              }


            } else {
              // 如果箱子上一个是墙壁 就不让人物运动
              oParent.x -= x;
              oParent.y -= y;
              oParent.style.left = oParent.x * 35 + 'px';
              oParent.style.top = oParent.y * 35 + 'px';
              oParent.style.zIndex = oParent.x + oParent.y * size.x;

              // 减少步骤移动
              stepNum--;
              step.person.pop();

            }
          }
        }

      }
    }

    //箱子与箱子碰撞检测
    function collision(obj, x, y) {
      // 获取所有的box
      var oBox = getBox('box', oWrap);

      // 遍历box
      for (var i = 0; i < oBox.length; i++) {
        if (oBox[i] != obj) {
          if (oBox[i].x == obj.x + x && oBox[i].y == obj.y + y) {
            return false;
          }
        }
      }
      return true;
    }

    // 获取box箱子的个数
    function getBox(cName, obj) {
      obj = obj || document;
      if (obj.getElementsByClassName) {
        return obj.getElementsByClassName(cName);
      } else {
        var arr = [];
        var allT = obj.getElementsByTagName('*');
        for (var i = 0; i < allE.length; i++) {
          var allTArr = allT[i].className.split(' ');
          for (var j = 0; j < allTArr.length; i++) {
            if (arrTArr[i] == cName) {
              arr.push(arrT[i]);
              break;
            }
          }
        }
        return arr;
      }
    }

    // 过关检测
    function pass() {
      var oBall = getBox('ball', oWrap);
      var oBox = getBox('box', oWrap);
      var passNum = 0;

      // 遍历oBall
      for (var i = 0; i < oBall.length; i++) {
        // 遍历oBox
        for (var j = 0; j < oBox.length; j++) {
          // 判断 如果所有的oBall和oBox的位置就passName +1
          if (oBall[i].x == oBox[j].x && oBall[i].y == oBox[i].y) {
            passNum++;
          }
        }
      }
      if (passNum == oBall.length) {



        if (level < mapData.length - 2) {
          alert('你过关了')
          level++;

        } else {
          alert('你已经全通关了');
          level = 0;
        }
        createMap(level)
      }

    }

    // 上一步函数
    function prev() {
      // 获取人物
      var oPerson = getBox('person', oWrap)[0];
      // 获取所有的box
      var aBox = getBox('box', oWrap);
      var oBoxNow;

      // 判断步数是否为0
      if (stepNum != 0) {

        // 通过step.person获取人物上一步的位置
        oPerson.x = step.person[stepNum - 1].x;
        oPerson.y = step.person[stepNum - 1].y;

        // 通过人物的位置,设置人物的回退
        oPerson.style.left = oPerson.x * 35 + 'px';
        oPerson.style.top = oPerson.y * 35 + 'px';
        oPerson.style.zIndex = oPerson.x + oPerson.y * size.x;
        oPerson.children[0].src = step.person[stepNum - 1].src;

        // 判断盒子有没有移动,有没有上一步
        if (step.box[stepNum - 1]) {
          oBoxNow = aBox[step.box[stepNum - 1].index];
          oBoxNow.x = step.box[stepNum - 1].x;
          oBoxNow.y = step.box[stepNum - 1].y;

          // 设置盒子会到移动的上一步
          oBoxNow.style.left = oBoxNow.x * 35 + 'px';
          oBoxNow.style.top = oBoxNow.y * 35 + 'px';
          oBoxNow.style.zIndex = oBoxNow.y * size.x;
        }
        stepNum--;
      }
    }



  </script>
</body>

</html>